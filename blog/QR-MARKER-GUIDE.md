# QRマーカーベースAR使用ガイド

## 概要
v4.0では、QRコードを基準点として使用する高精度な位置推定システムを実装しました。これにより、iPhoneでも確実な空間固定ARが実現できます。

## 特徴

### ✅ iPhone完全対応
- センサー許可不要
- 高精度な位置推定
- 確実な空間固定

### ✅ 簡単セットアップ
- QRコード1つで位置基準設定
- 自動マーカー検知
- ワンタップモデル配置

### ✅ 実用的な精度
- マーカー基準の相対位置計算
- 安定した追跡性能
- 複数モデル配置対応

## 使用方法

### 1. アプリケーション起動
```
https://192.168.0.9:5173/ar-marker-based.html
```

### 2. QRマーカー準備

#### 方法A: アプリ内生成
1. 「QR-ARを開始する」をタップ
2. カメラ許可を承認
3. 「テスト用QRコード生成」をタップ
4. 生成されたQRコードを別デバイスで表示または印刷

#### 方法B: 独自QRコード
以下の形式でQRコードを生成：
```json
{
  "id": "marker_001",
  "x": 0,
  "y": 0, 
  "z": 0,
  "rx": 0,
  "ry": 0,
  "rz": 0,
  "size": 1.0
}
```

### 3. マーカー検知
1. QRコードを画面中央の枠内に合わせる
2. 自動検知されると緑色のインジケーターが点灯
3. マーカー追跡が開始される

### 4. モデル配置
1. 「サンプルモデル読み込み」をタップ
2. 「モデル配置」をタップ
3. モデルがマーカー位置に固定配置される

## 技術仕様

### QR検知システム
- **ライブラリ**: jsQR v1.4.0
- **検知間隔**: 0.5秒
- **解像度**: 640x480px
- **対応形式**: JSON、プレーンテキスト

### 位置推定アルゴリズム
- **基準系**: マーカー相対座標
- **追跡方式**: QRコードベース基準点追跡
- **精度**: マーカーサイズ依存（推奨10cm以上）

### モデル配置
- **配置方式**: マーカー位置基準
- **固定方式**: 絶対座標固定
- **複数配置**: 対応

## トラブルシューティング

### QRコードが検知されない
- **解決策**:
  - QRコードのサイズを大きくする（推奨10cm以上）
  - 照明を明るくする
  - カメラとQRコードの距離を調整（30cm-1m）
  - QRコードが平らになるよう配置

### モデルが表示されない
- **原因**: マーカー追跡が未完了
- **解決策**: 
  - QR検知を再実行
  - 「追跡リセット」ボタンを使用
  - デバッグモードで状態確認

### 位置がずれる
- **原因**: マーカーの傾きや距離
- **解決策**:
  - QRコードを水平に設置
  - カメラをQRコードに正面から向ける
  - マーカーサイズを正確に設定

## 推奨環境設定

### QRマーカー設置
- **サイズ**: 10cm x 10cm 以上
- **設置面**: 平らな床または机
- **照明**: 十分な明るさ
- **背景**: コントラストの高い背景

### カメラ設定
- **距離**: マーカーから30cm-1m
- **角度**: 正面から（±30度以内）
- **安定性**: 手ブレを最小限に

## 高度な使用方法

### 複数マーカーシステム
```json
{
  "id": "marker_A",
  "x": 0, "y": 0, "z": 0,
  "next_marker": "marker_B"
}
```

### マーカーサイズ指定
```json
{
  "id": "large_marker",
  "size": 2.0,
  "scale_factor": 1.5
}
```

### 座標系設定
```json
{
  "id": "room_origin", 
  "x": 0, "y": 0, "z": 0,
  "coordinate_system": "room_space"
}
```

## デバッグ機能

### デバッグモード有効化
```
https://192.168.0.9:5173/ar-marker-based.html?debug=true
```

### 確認項目
- **isQRDetectionActive**: QR検知状態
- **isTracking**: マーカー追跡状態
- **currentMarkerId**: 検知中のマーカーID
- **markerX/Y/Z**: マーカー座標
- **deviceX/Y/Z**: デバイス相対位置

## パフォーマンス最適化

### 推奨設定
- QR検知間隔: 0.5秒（バランス重視）
- キャンバス解像度: 640x480（精度重視）
- マーカーサイズ: 10cm以上（検知精度重視）

### iPhoneでの最適化
- Safari最新版使用
- 十分なメモリ確保
- バックグラウンドアプリ終了

## 実用例

### 展示会での使用
1. 展示台にQRマーカー設置
2. 来場者がスマホでスキャン
3. 3Dモデルが展示台に表示

### 教育現場での使用
1. 教科書にQRコード印刷
2. 生徒がスマホでスキャン
3. 関連する3Dモデルが教科書上に表示

### 家庭での使用
1. テーブルにQRコード設置
2. 家族がARで3Dコンテンツ共有
3. 同じ位置に安定してモデル表示

## まとめ

QRマーカーベースARシステムにより、iPhoneでも確実で高精度な空間固定ARが実現できます。センサーベースの複雑な位置推定を回避し、視覚的に明確な基準点を使用することで、実用的なARアプリケーションを構築できます。